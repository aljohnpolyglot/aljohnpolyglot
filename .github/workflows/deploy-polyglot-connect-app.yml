# .github/workflows/deploy-polyglot-connect-app.yml
name: Deploy Full Site with Polyglot Connect App to GitHub Pages

on:
  push:
    branches:
      - main
    # Consider removing path filters for now if this deploys the whole site,
    # or make them very broad if you only want to trigger on relevant changes.
    # paths:
    #   - '**' # Trigger on any change
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout 🛎️
        uses: actions/checkout@v4 # Checks out your 'main' branch code to the workspace root

      - name: Create API Keys file for Polyglot Connect 🔑
        run: |
          echo "Creating directory for API keys: ./polyglot_connect/js/config"
          # This assumes 'polyglot_connect' folder is at the root of your checkout
          mkdir -p ./polyglot_connect/js/config 

          API_KEYS_FILE_PATH="./polyglot_connect/js/config/api_keys.js"
          echo "Creating $API_KEYS_FILE_PATH with secrets..."

          echo "// This file is auto-generated by GitHub Action during deployment." > "$API_KEYS_FILE_PATH"
          echo "console.log('api_keys.js (generated by GitHub Action for Polyglot Connect) loaded.');" >> "$API_KEYS_FILE_PATH"
          echo "window.GEMINI_API_KEY = '${{ secrets.GEMINI_API_KEY }}';" >> "$API_KEYS_FILE_PATH"
          echo "window.GEMINI_API_KEY_ALT = '${{ secrets.GEMINI_API_KEY_ALT }}';" >> "$API_KEYS_FILE_PATH"
          echo "window.GEMINI_API_KEY_ALT_2 = '${{ secrets.GEMINI_API_KEY_ALT_2 }}';" >> "$API_KEYS_FILE_PATH"
          echo "window.GROQ_API_KEY = '${{ secrets.GROQ_API_KEY }}';" >> "$API_KEYS_FILE_PATH"
          echo "window.TOGETHER_API_KEY = '${{ secrets.TOGETHER_API_KEY }}';" >> "$API_KEYS_FILE_PATH"
          
          echo "$API_KEYS_FILE_PATH created successfully."
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GEMINI_API_KEY_ALT: ${{ secrets.GEMINI_API_KEY_ALT }}
          GEMINI_API_KEY_ALT_2: ${{ secrets.GEMINI_API_KEY_ALT_2 }}
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
          TOGETHER_API_KEY: ${{ secrets.TOGETHER_API_KEY }}

      # No separate verify step needed here as the publish_dir will be the whole repo content

      - name: Deploy to root of gh-pages branch 🚀
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          # publish_dir is now the root of your checked-out main branch,
          # which includes the polyglot_connect folder with the generated api_keys.js
          publish_dir: .  # <--- IMPORTANT CHANGE: Deploy entire workspace root
          # destination_dir is not needed if publishing to the root of gh-pages
          keep_files: false 
          force_orphan: true 
          # user_name: 'github-actions[bot]' # Optional
          # user_email: 'github-actions[bot]@users.noreply.github.com' # Optional